function [r,v] = joshCOE2rv(a,ecc,theta,inc,raan,aop,mu)
% all angles in rads

rp = (1-ecc^2)/(1+ecc); % cos(0) = 1
h = sqrt(mu*rp*(1+ecc*cos(theta)));

% vp = h/rp;
% 
% rp = [1,0,0]*rp; % in perifocal at periapse
% vp = [0,1,0]*vp;

r = (h^2/mu)/(1+ecc*cos(theta));
r = [cos(theta);sin(theta);0]*r;
[vaz,vr] = joshVazVr(theta,ecc,h,mu);
vloc = [vaz;vr;0];

Q = Cz(raan)*Cx(inc)*Cz(aop); 
Q = Q'; % Perifocal -> ECI

r = r*Q; % rotation to get to Inertial frame
v = v*Q;

end